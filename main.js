"use strict";var p=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var x=(o,r)=>{for(var e in r)p(o,e,{get:r[e],enumerable:!0})},P=(o,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of C(r))!S.call(o,n)&&n!==e&&p(o,n,{get:()=>r[n],enumerable:!(t=w(r,n))||t.enumerable});return o};var U=o=>P(p({},"__esModule",{value:!0}),o);var $={};x($,{default:()=>c});module.exports=U($);var a=require("obsidian");function m(){let o=window;return typeof o.require=="function"?o.require:null}function I(){let o=m();if(!o)return null;try{return o("http")}catch(r){return null}}function k(){let o=m();if(!o)return null;try{return o("electron").shell}catch(r){return null}}var y={routeStyle:"query",addHeadingAnchor:!0,vaultNameOverride:"",baseUrl:"http://127.0.0.1:27124",useIntegratedServer:!0,serverPort:27124,listenHost:"127.0.0.1"},c=class extends a.Plugin{constructor(){super(...arguments);this.settings=y;this.server=null}async onload(){await this.loadSettings(),this.addRibbonIcon("link","Copiar enlace web\u2011proxy de la nota actual",async()=>{let e=this.app.workspace.getActiveFile();if(!e)return new a.Notice("No hay nota activa");await this.copyForFile(e,!0)}),this.addCommand({id:"copy-proxy-link-current",name:"Copiar enlace web\u2011proxy de la nota actual",editorCheckCallback:(e,t,n)=>{let i=this.app.workspace.getActiveFile();return i?(e||this.copyForFile(i,!0),!0):!1}}),this.addCommand({id:"insert-proxy-link-current",name:"Insertar enlace web\u2011proxy en el editor",editorCheckCallback:(e,t,n)=>{let i=this.app.workspace.getActiveFile();return i?(e||this.insertLinkInEditor(i,t),!0):!1}}),this.registerEvent(this.app.workspace.on("file-menu",(e,t)=>{t instanceof a.TFile&&e.addItem(n=>n.setTitle("Copiar enlace web\u2011proxy").setIcon("link").onClick(()=>this.copyForFile(t,!1)))})),this.addSettingTab(new h(this.app,this)),this.settings.useIntegratedServer&&this.startServer()}onunload(){this.stopServer()}startServer(){if(this.server)return;let e=I(),t=k();if(!e||!t){new a.Notice("Web Proxy Linker: servidor integrado desactivado (sandbox activo). Usa proxy externo o desactiva el sandbox.");return}let n=this.settings.serverPort,i=this.settings.listenHost||"127.0.0.1";this.server=e.createServer((s,l)=>this.handleRequest(s,l,t)),this.server.on("error",s=>{console.error("Proxy server error",s),new a.Notice(`Web Proxy Linker: error al iniciar el servidor (${(s==null?void 0:s.code)||s}).`)}),this.server.listen(n,i,()=>{new a.Notice(`Web Proxy Linker: servidor en http://${i}:${n}`)})}stopServer(){if(this.server){try{this.server.close()}catch(e){}this.server=null}}htmlOk(e="Abriendo en Obsidian\u2026 ya puedes cerrar esta pesta\xF1a."){return`<!doctype html><meta charset="utf-8"><meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'">${e}`}handleRequest(e,t,n){try{let i=e.headers.host||"127.0.0.1",s=new URL(e.url||"/",`http://${i}`);if(t.setHeader("X-Content-Type-Options","nosniff"),t.setHeader("Content-Type","text/html; charset=utf-8"),s.pathname==="/ping"||s.pathname==="/health"){t.statusCode=200,t.end(this.htmlOk("OK"));return}if(s.pathname==="/open"){let l=s.searchParams.get("u")||"",d=decodeURIComponent(l);if(!/^obsidian:\/\//i.test(d)){t.statusCode=400,t.end("URL no v\xE1lida (se requiere obsidian://)");return}n.openExternal(d),t.statusCode=200,t.end(this.htmlOk());return}if(s.pathname.startsWith("/v/")){let l=s.pathname.split("/").slice(2),d=l.shift()||"",u=decodeURIComponent(d),f=l.map(b=>decodeURIComponent(b)).join("/"),g=s.searchParams.get("h")||void 0,v=`obsidian://open?vault=${encodeURIComponent(u)}&file=${encodeURIComponent(f)}`;g&&(v+=`#${encodeURIComponent(g)}`),n.openExternal(v),t.statusCode=200,t.end(this.htmlOk());return}t.statusCode=404,t.end("No encontrado")}catch(i){console.error(i),t.statusCode=500,t.end("Error interno")}}sanitizeBase(e){return e.replace(/\/+$/,"")}getVaultName(){var e;return((e=this.settings.vaultNameOverride)==null?void 0:e.trim())||this.app.vault.getName()}buildObsidianUrl(e,t){let n=encodeURIComponent(this.getVaultName()),i=encodeURIComponent(e.path),s=`obsidian://open?vault=${n}&file=${i}`;return t&&(s+=`#${encodeURIComponent(t)}`),s}getBaseUrl(){return this.settings.useIntegratedServer?`http://${this.settings.listenHost||"127.0.0.1"}:${this.settings.serverPort}`:this.sanitizeBase(this.settings.baseUrl||"http://127.0.0.1:27124")}buildProxyUrl(e,t){let n=this.getBaseUrl();if(this.settings.routeStyle==="pretty"){let i=encodeURIComponent(this.getVaultName()),s=e.path.split("/").map(encodeURIComponent).join("/"),l=t?`?h=${encodeURIComponent(t)}`:"";return`${n}/v/${i}/${s}${l}`}else{let i=this.buildObsidianUrl(e,t);return`${n}/open?u=${encodeURIComponent(i)}`}}getHeadingFromEditorIfAny(e){var s;if(!this.settings.addHeadingAnchor)return;let t=this.app.workspace.getActiveViewOfType(a.MarkdownView);if(!t||((s=t.file)==null?void 0:s.path)!==e.path)return;let n=t.editor,i=n.getCursor().line;for(let l=i;l>=0;l--){let d=n.getLine(l),u=/^\s*#+\s+(.+)$/.exec(d);if(u)return u[1].trim()}}async copyForFile(e,t){let n=t?this.getHeadingFromEditorIfAny(e):void 0,i=this.buildProxyUrl(e,n),s=await this.copyToClipboard(i);new a.Notice(s?"Enlace copiado al portapapeles":i)}async insertLinkInEditor(e,t){let n=this.getHeadingFromEditorIfAny(e),i=this.buildProxyUrl(e,n),l=`[${e.basename+(n?` \u2014 ${n}`:"")}](${i})`;t.replaceSelection(l),new a.Notice("Enlace insertado")}async copyToClipboard(e){try{return await navigator.clipboard.writeText(e),!0}catch(t){try{let n=document.createElement("textarea");return n.value=e,document.body.appendChild(n),n.select(),document.execCommand("copy"),n.remove(),!0}catch(n){return!1}}}async loadSettings(){this.settings=Object.assign({},y,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.settings.useIntegratedServer?(this.stopServer(),this.startServer()):this.stopServer()}},h=class extends a.PluginSettingTab{constructor(r,e){super(r,e),this.plugin=e}display(){let{containerEl:r}=this;r.empty(),r.createEl("h2",{text:"Web Proxy Linker"}),new a.Setting(r).setName("Usar servidor integrado").setDesc("Levanta http://127.0.0.1:<puerto>. Si est\xE1s en sandbox, se desactivar\xE1 solo.").addToggle(e=>e.setValue(this.plugin.settings.useIntegratedServer).onChange(async t=>{this.plugin.settings.useIntegratedServer=t,await this.plugin.saveSettings()})),new a.Setting(r).setName("Puerto del servidor").setDesc("Por defecto 27124").addText(e=>e.setPlaceholder("27124").setValue(String(this.plugin.settings.serverPort)).onChange(async t=>{let n=parseInt(t,10);!isNaN(n)&&n>0&&n<65536&&(this.plugin.settings.serverPort=n),await this.plugin.saveSettings()})),new a.Setting(r).setName("Host a escuchar").setDesc("Usa 127.0.0.1 para no exponerlo fuera de tu equipo").addText(e=>e.setPlaceholder("127.0.0.1").setValue(this.plugin.settings.listenHost).onChange(async t=>{this.plugin.settings.listenHost=(t||"127.0.0.1").trim(),await this.plugin.saveSettings()})),new a.Setting(r).setName("Base URL del proxy (externo)").setDesc("S\xF3lo se usa si el servidor integrado est\xE1 OFF").addText(e=>e.setPlaceholder("http://localhost:27124").setValue(this.plugin.settings.baseUrl).onChange(async t=>{this.plugin.settings.baseUrl=t.trim(),await this.plugin.saveSettings()})),new a.Setting(r).setName("Estilo de ruta").setDesc("'query' usa /open?u=..., 'pretty' usa /v/<Vault>/<ruta>?h=Heading").addDropdown(e=>e.addOptions({query:"query",pretty:"pretty"}).setValue(this.plugin.settings.routeStyle).onChange(async t=>{this.plugin.settings.routeStyle=t,await this.plugin.saveSettings()})),new a.Setting(r).setName("Usar heading actual si existe").setDesc("A\xF1ade autom\xE1ticamente el encabezado seg\xFAn la posici\xF3n del cursor").addToggle(e=>e.setValue(this.plugin.settings.addHeadingAnchor).onChange(async t=>{this.plugin.settings.addHeadingAnchor=t,await this.plugin.saveSettings()})),new a.Setting(r).setName("Nombre de vault (opcional)").setDesc("D\xE9jalo vac\xEDo para usar el nombre real del vault").addText(e=>e.setPlaceholder("MiVault").setValue(this.plugin.settings.vaultNameOverride).onChange(async t=>{this.plugin.settings.vaultNameOverride=t.trim(),await this.plugin.saveSettings()}))}};
//# sourceMappingURL=main.js.map
