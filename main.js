"use strict";var R=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var q=Object.prototype.hasOwnProperty;var M=(r,n)=>{for(var e in n)R(r,e,{get:n[e],enumerable:!0})},K=(r,n,e,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let i of H(n))!q.call(r,i)&&i!==e&&R(r,i,{get:()=>n[i],enumerable:!(t=E(n,i))||t.enumerable});return r};var B=r=>K(R({},"__esModule",{value:!0}),r);var X={};M(X,{default:()=>F});module.exports=B(X);var u=require("obsidian");var l=require("obsidian"),U=class extends l.PluginSettingTab{constructor(n,e){super(n,e),this.plugin=e}display(){let{containerEl:n}=this;n.empty(),n.createEl("h2",{text:"Web Proxy Linker"}),new l.Setting(n).setName("Use integrated server").setDesc("Starts http://127.0.0.1:<port>. If sandboxed, it will auto-disable.").addToggle(e=>e.setValue(this.plugin.settings.useIntegratedServer).onChange(async t=>{this.plugin.settings.useIntegratedServer=t,await this.plugin.saveSettings()})),new l.Setting(n).setName("Server port").setDesc("Default 27124").addText(e=>e.setPlaceholder("27124").setValue(String(this.plugin.settings.serverPort)).onChange(async t=>{let i=parseInt(t,10);!isNaN(i)&&i>0&&i<65536&&(this.plugin.settings.serverPort=i),await this.plugin.saveSettings()})),new l.Setting(n).setName("Listen host").setDesc("Use 127.0.0.1 to keep it local only").addText(e=>e.setPlaceholder("127.0.0.1").setValue(this.plugin.settings.listenHost).onChange(async t=>{this.plugin.settings.listenHost=(t||"127.0.0.1").trim(),await this.plugin.saveSettings()})),new l.Setting(n).setName("External proxy Base URL").setDesc("Only used if integrated server is OFF").addText(e=>e.setPlaceholder("http://localhost:27124").setValue(this.plugin.settings.baseUrl).onChange(async t=>{this.plugin.settings.baseUrl=t.trim(),await this.plugin.saveSettings()})),new l.Setting(n).setName("Route style").setDesc("'query' uses /open?u=..., 'pretty' uses /v/<Vault>/<path>?h=Heading").addDropdown(e=>e.addOptions({query:"query",pretty:"pretty"}).setValue(this.plugin.settings.routeStyle).onChange(async t=>{this.plugin.settings.routeStyle=t,await this.plugin.saveSettings()})),new l.Setting(n).setName("Add current heading if available").setDesc("Automatically add heading anchor based on the cursor position").addToggle(e=>e.setValue(this.plugin.settings.addHeadingAnchor).onChange(async t=>{this.plugin.settings.addHeadingAnchor=t,await this.plugin.saveSettings()})),new l.Setting(n).setName("Vault name override (optional)").setDesc("Leave empty to use the vault's real name").addText(e=>e.setPlaceholder("MyVault").setValue(this.plugin.settings.vaultNameOverride).onChange(async t=>{this.plugin.settings.vaultNameOverride=t.trim(),await this.plugin.saveSettings()})),n.createEl("h3",{text:"Linking strategy"}),new l.Setting(n).setName("Strategy").setDesc("Choose how links stay stable when files move").addDropdown(e=>e.addOptions({path:"Path (current behavior)","frontmatter-uid":"Frontmatter UID","local-registry":"Local registry (no file changes)",basename:"Basename (search on duplicates)"}).setValue(this.plugin.settings.linkStrategy).onChange(async t=>{this.plugin.settings.linkStrategy=t,await this.plugin.saveSettings()})),new l.Setting(n).setName("On duplicates: open Search").setDesc("If multiple files share the same basename, open Search with the query").addToggle(e=>e.setValue(this.plugin.settings.basenameOpenSearchOnDuplicates).onChange(async t=>{this.plugin.settings.basenameOpenSearchOnDuplicates=t,await this.plugin.saveSettings()})),new l.Setting(n).setName("Prefer QuickSwitcher++ on duplicates").setDesc("If installed, try to open Quick Switcher++ instead of Search (query cannot be prefilled)").addToggle(e=>e.setValue(this.plugin.settings.basenamePreferQuickSwitcherPlus).onChange(async t=>{this.plugin.settings.basenamePreferQuickSwitcherPlus=t,await this.plugin.saveSettings()})),n.createEl("h3",{text:"Frontmatter UID"}),new l.Setting(n).setName("Use Note UID Generator compatibility").setDesc("Respect the same YAML key if that plugin is present").addToggle(e=>e.setValue(this.plugin.settings.useNoteUidCompat).onChange(async t=>{this.plugin.settings.useNoteUidCompat=t,await this.plugin.saveSettings()})),new l.Setting(n).setName("Preferred YAML key").setDesc("Key used to read/write UID in frontmatter").addText(e=>e.setPlaceholder("uid").setValue(this.plugin.settings.frontmatterUidKeyPreferred).onChange(async t=>{this.plugin.settings.frontmatterUidKeyPreferred=(t||"uid").trim(),await this.plugin.saveSettings()})),new l.Setting(n).setName("Also recognize keys").setDesc("Comma-separated list (e.g. uid,note_uid,noteId,id)").addText(e=>e.setPlaceholder("uid,note_uid,noteId,id").setValue(this.plugin.settings.frontmatterUidKeys.join(",")).onChange(async t=>{this.plugin.settings.frontmatterUidKeys=(t||"").split(",").map(i=>i.trim()).filter(Boolean),await this.plugin.saveSettings()})),new l.Setting(n).setName("Auto-assign UID if missing").setDesc("Assign a UID on first use if the note has none").addToggle(e=>e.setValue(this.plugin.settings.autoAssignUid).onChange(async t=>{this.plugin.settings.autoAssignUid=t,await this.plugin.saveSettings()})),new l.Setting(n).setName("UID format").setDesc("Default uuid-v4; nanoid-21 is compact; timestamp-rand is sortable").addDropdown(e=>e.addOptions({"uuid-v4":"uuid-v4","nanoid-21":"nanoid-21","timestamp-rand":"timestamp-rand"}).setValue(this.plugin.settings.uidFormat).onChange(async t=>{this.plugin.settings.uidFormat=t,await this.plugin.saveSettings()}))}};var b={routeStyle:"query",addHeadingAnchor:!0,vaultNameOverride:"",baseUrl:"http://127.0.0.1:27124",useIntegratedServer:!0,serverPort:27124,listenHost:"127.0.0.1",linkStrategy:"path",useNoteUidCompat:!0,noteUidPluginId:null,frontmatterUidKeys:["uid","note_uid","noteId","id"],frontmatterUidKeyPreferred:"uid",autoAssignUid:!1,uidFormat:"uuid-v4",basenameOpenSearchOnDuplicates:!0,basenamePreferQuickSwitcherPlus:!1};function W(r){return r.replace(/\/+$/,"")}function v(r,n){var e;return((e=n.vaultNameOverride)==null?void 0:e.trim())||r.vault.getName()}function O(r){return r.useIntegratedServer?`http://${r.listenHost||"127.0.0.1"}:${r.serverPort}`:W(r.baseUrl||"http://127.0.0.1:27124")}function I(r,n,e){var i;let t=(i=r.metadataCache.getFileCache(n))==null?void 0:i.frontmatter;if(t)for(let s of e){let o=t[s];if(typeof o=="string"&&o.trim())return o.trim()}}async function N(r,n,e){let t=I(r,n,[e.frontmatterUidKeyPreferred,...e.frontmatterUidKeys]);if(t)return t;if(e.autoAssignUid){t=j(e.uidFormat);try{return await r.fileManager.processFrontMatter(n,i=>{i[e.frontmatterUidKeyPreferred]=t}),t}catch(i){return}}}function j(r){if(r==="uuid-v4")return Q();if(r==="nanoid-21")return _();let n=Math.random().toString(36).slice(2,10);return`${Date.now().toString(36)}-${n}`}function Q(){var e;let r=globalThis;if((e=r.crypto)!=null&&e.getRandomValues){let t=new Uint8Array(16);r.crypto.getRandomValues(t),t[6]=t[6]&15|64,t[8]=t[8]&63|128;let i=[...t].map(s=>s.toString(16).padStart(2,"0")).join("");return`${i.slice(0,8)}-${i.slice(8,12)}-${i.slice(12,16)}-${i.slice(16,20)}-${i.slice(20)}`}let n="";for(let t=0;t<36;t++)n+="x";return n.replace(/[xy]/g,t=>{let i=Math.random()*16|0;return(t==="x"?i:i&3|8).toString(16)})}function _(){var i;let r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz-",n=globalThis,e=new Uint8Array(21);if((i=n.crypto)!=null&&i.getRandomValues)n.crypto.getRandomValues(e);else for(let s=0;s<e.length;s++)e[s]=Math.random()*256|0;let t="";for(let s=0;s<e.length;s++)t+=r[e[s]&63];return t}var k=class{constructor(n,e,t){this.uidIndex=new Map;this.app=n,this.settings=e,this.plugin=t}rebuildAll(){this.uidIndex.clear();let n=this.app.vault.getFiles();for(let e of n){let t=I(this.app,e,[this.settings.frontmatterUidKeyPreferred,...this.settings.frontmatterUidKeys]);t&&this.uidIndex.set(t,e.path)}}getPathByUid(n){if(n)return this.uidIndex.get(n)}onFrontmatterChanged(n){let e=I(this.app,n,[this.settings.frontmatterUidKeyPreferred,...this.settings.frontmatterUidKeys]);for(let[t,i]of Array.from(this.uidIndex.entries()))i===n.path&&this.uidIndex.delete(t);e&&this.uidIndex.set(e,n.path)}onFileRenamed(n,e){for(let[t,i]of Array.from(this.uidIndex.entries()))i===n&&this.uidIndex.set(t,e.path);for(let[t,i]of Object.entries(this.plugin.registry))i===n&&(this.plugin.registry[t]=e.path)}onFileDeleted(n){for(let[e,t]of Array.from(this.uidIndex.entries()))t===n&&this.uidIndex.delete(e);for(let[e,t]of Object.entries(this.plugin.registry))t===n&&delete this.plugin.registry[e]}getPathByLocalId(n){if(n)return this.plugin.registry[n]}ensureLocalIdForPath(n){for(let[t,i]of Object.entries(this.plugin.registry))if(i===n)return t;let e=this.makeLocalId();return this.plugin.registry[e]=n,e}makeLocalId(){let n=Math.random().toString(36).slice(2,10);return`${Date.now().toString(36)}-${n}`}};function P(r,n){let t=r.workspace.getLeavesOfType("search")[0]||r.workspace.getRightLeaf(!1);t.setViewState({type:"search",state:{query:n}}),r.workspace.revealLeaf(t)}function L(r){var t;let n=(t=r.commands)==null?void 0:t.commands;if(!n)return!1;let e=["darlal-switcher-plus:switcher-plus:open","darlal-switcher-plus:switcher-plus:open-editors","quick-switcher-plus:open","switcher-plus:open","obsidian-quick-switcher-plus:open","switcher:open"];for(let i of e)if(n[i])return r.commands.executeCommandById(i),!0;return n["switcher:open"]?(r.commands.executeCommandById("switcher:open"),!0):!1}function V(){let r=window;return typeof r.require=="function"?r.require:null}function G(){let r=V();if(!r)return null;try{return r("http")}catch(n){return null}}function z(){let r=V();if(!r)return null;try{return r("electron").shell}catch(n){return null}}var C=class{constructor(n){this.server=null;this.plugin=n}start(){if(this.server)return;let n=G(),e=z();if(!n||!e)return;let{settings:t,app:i}=this.plugin,s=t.serverPort,o=t.listenHost||"127.0.0.1";this.server=n.createServer((d,a)=>this.handleRequest(d,a,e)),this.server.on("error",d=>{console.error("Proxy server error",d)}),this.server.listen(s,o,()=>{})}stop(){if(this.server){try{this.server.close()}catch(n){}this.server=null}}htmlOk(n="Opening in Obsidian\u2026 you can close this tab."){return`<!doctype html><meta charset="utf-8"><meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'">${n}`}handleRequest(n,e,t){let{app:i,settings:s,indexer:o}=this.plugin;try{let d=n.headers.host||"127.0.0.1",a=new URL(n.url||"/",`http://${d}`);if(e.setHeader("X-Content-Type-Options","nosniff"),e.setHeader("Content-Type","text/html; charset=utf-8"),a.pathname==="/ping"||a.pathname==="/health"){e.statusCode=200,e.end(this.htmlOk("OK"));return}if(a.pathname==="/open"){let g=a.searchParams.get("u")||"",S=a.searchParams.get("uid"),m=a.searchParams.get("id"),h=a.searchParams.get("bn"),p=a.searchParams.get("h")||void 0,c;if(S&&(c=o.getPathByUid(S)),!c&&m&&(c=o.getPathByLocalId(m)),!c&&h){let f=i.vault.getFiles().filter(x=>x.basename===h);if(f.length===1)c=f[0].path;else if(f.length>1){s.basenamePreferQuickSwitcherPlus?L(i)||P(i,h):P(i,h),e.statusCode=200,e.end(this.htmlOk("Multiple files match; opened Search."));return}}if(c){let f=encodeURIComponent(i.vault.getName()),x=encodeURIComponent(c),w=`obsidian://open?vault=${f}&file=${x}`;p&&(w+=`#${encodeURIComponent(p)}`),t.openExternal(w),e.statusCode=200,e.end(this.htmlOk());return}if(g&&/^obsidian:\/\//i.test(decodeURIComponent(g))){t.openExternal(decodeURIComponent(g)),e.statusCode=200,e.end(this.htmlOk());return}e.statusCode=404,e.end("Not found");return}if(a.pathname.startsWith("/v/")){let g=a.searchParams.get("uid"),S=a.searchParams.get("id"),m=a.searchParams.get("bn"),h=a.searchParams.get("h")||void 0,p;if(g&&(p=o.getPathByUid(g)),!p&&S&&(p=o.getPathByLocalId(S)),!p&&m){let y=i.vault.getFiles().filter($=>$.basename===m);if(y.length===1)p=y[0].path;else if(y.length>1&&s.basenameOpenSearchOnDuplicates){s.basenamePreferQuickSwitcherPlus?L(i)||P(i,m):P(i,m),e.statusCode=200,e.end(this.htmlOk("Multiple files match; opened Search."));return}}if(p){let y=encodeURIComponent(i.vault.getName()),$=encodeURIComponent(p),D=`obsidian://open?vault=${y}&file=${$}`;h&&(D+=`#${encodeURIComponent(h)}`),t.openExternal(D),e.statusCode=200,e.end(this.htmlOk());return}let c=a.pathname.split("/").slice(2),f=c.shift()||"",x=c.map(y=>decodeURIComponent(y)).join("/"),w=decodeURIComponent(f),T=`obsidian://open?vault=${encodeURIComponent(w)}&file=${encodeURIComponent(x)}`;h&&(T+=`#${encodeURIComponent(h)}`),t.openExternal(T),e.statusCode=200,e.end(this.htmlOk());return}e.statusCode=404,e.end("Not found")}catch(d){console.error(d),e.statusCode=500,e.end("Internal error")}}};function Y(r,n,e,t){let i=encodeURIComponent(v(r,n)),s=encodeURIComponent(e.path),o=`obsidian://open?vault=${i}&file=${s}`;return t&&(o+=`#${encodeURIComponent(t)}`),o}async function A(r,n,e,t,i){let s=O(n),o=Y(r,n,t,i),d=i?`&h=${encodeURIComponent(i)}`:"";switch(n.linkStrategy){case"frontmatter-uid":{let a=await N(r,t,n);return n.routeStyle==="pretty"?`${s}/v/${encodeURIComponent(v(r,n))}/${t.path.split("/").map(encodeURIComponent).join("/")}?uid=${encodeURIComponent(a||"")}${d}`:`${s}/open?uid=${encodeURIComponent(a||"")}&u=${encodeURIComponent(o)}${d}`}case"local-registry":{let a=e.ensureLocalIdForPath(t.path);return n.routeStyle==="pretty"?`${s}/v/${encodeURIComponent(v(r,n))}/${t.path.split("/").map(encodeURIComponent).join("/")}?id=${encodeURIComponent(a)}${d}`:`${s}/open?id=${encodeURIComponent(a)}&u=${encodeURIComponent(o)}${d}`}case"basename":{let a=t.basename;return n.routeStyle==="pretty"?`${s}/v/${encodeURIComponent(v(r,n))}/${t.path.split("/").map(encodeURIComponent).join("/")}?bn=${encodeURIComponent(a)}${d}`:`${s}/open?bn=${encodeURIComponent(a)}&u=${encodeURIComponent(o)}${d}`}case"path":default:if(n.routeStyle==="pretty"){let a=i?`?h=${encodeURIComponent(i)}`:"";return`${s}/v/${encodeURIComponent(v(r,n))}/${t.path.split("/").map(encodeURIComponent).join("/")}${a}`}else return`${s}/open?u=${encodeURIComponent(o)}`}}var F=class extends u.Plugin{constructor(){super(...arguments);this.settings=b;this.registry={};this.server=null}async onload(){await this.loadSettings(),this.indexer=new k(this.app,this.settings,this),this.indexer.rebuildAll(),this.registerEvent(this.app.metadataCache.on("changed",e=>{e instanceof u.TFile&&this.indexer.onFrontmatterChanged(e)})),this.registerEvent(this.app.vault.on("rename",(e,t)=>{e instanceof u.TFile&&this.indexer.onFileRenamed(t,e)})),this.registerEvent(this.app.vault.on("delete",e=>{e instanceof u.TFile&&this.indexer.onFileDeleted(e.path)})),this.addRibbonIcon("link","Copy web-proxy link of current note",async()=>{let e=this.app.workspace.getActiveFile();if(!e)return new u.Notice("No active note");await this.copyForFile(e,!0)}),this.addCommand({id:"copy-proxy-link-current",name:"Copy web-proxy link of current note",editorCheckCallback:(e,t,i)=>{let s=this.app.workspace.getActiveFile();return s?(e||this.copyForFile(s,!0),!0):!1}}),this.addCommand({id:"insert-proxy-link-current",name:"Insert web-proxy link into editor",editorCheckCallback:(e,t,i)=>{let s=this.app.workspace.getActiveFile();return s?(e||this.insertLinkInEditor(s,t),!0):!1}}),this.registerEvent(this.app.workspace.on("file-menu",(e,t)=>{t instanceof u.TFile&&e.addItem(i=>i.setTitle("Copy web-proxy link").setIcon("link").onClick(()=>this.copyForFile(t,!1)))})),this.addSettingTab(new U(this.app,this)),this.settings.useIntegratedServer&&this.startServer()}onunload(){this.stopServer()}startServer(){this.server||(this.server=new C(this),this.server.start(),this.settings.useIntegratedServer&&new u.Notice(`Web Proxy Linker: server ${this.settings.listenHost}:${this.settings.serverPort}`))}stopServer(){this.server&&(this.server.stop(),this.server=null)}getHeadingFromEditorIfAny(e){var o;if(!this.settings.addHeadingAnchor)return;let t=this.app.workspace.getActiveViewOfType(u.MarkdownView);if(!t||((o=t.file)==null?void 0:o.path)!==e.path)return;let i=t.editor,s=i.getCursor().line;for(let d=s;d>=0;d--){let a=i.getLine(d),g=/^\s*#+\s+(.+)$/.exec(a);if(g)return g[1].trim()}}async copyForFile(e,t){let i=t?this.getHeadingFromEditorIfAny(e):void 0,s=await A(this.app,this.settings,this.indexer,e,i),o=await this.copyToClipboard(s);new u.Notice(o?"Link copied to clipboard":s)}async insertLinkInEditor(e,t){let i=this.getHeadingFromEditorIfAny(e),s=await A(this.app,this.settings,this.indexer,e,i),d=`[${e.basename+(i?` \u2014 ${i}`:"")}](${s})`;t.replaceSelection(d),new u.Notice("Link inserted")}async copyToClipboard(e){try{return await navigator.clipboard.writeText(e),!0}catch(t){try{let i=document.createElement("textarea");return i.value=e,document.body.appendChild(i),i.select(),document.execCommand("copy"),i.remove(),!0}catch(i){return!1}}}async loadSettings(){let e=await this.loadData();if(!e){this.settings={...b},this.registry={};return}if(e&&e.routeStyle)this.settings=Object.assign({},b,e),this.registry={};else{let t=e;this.settings=Object.assign({},b,t.settings),this.registry=t.registry||{}}}async saveSettings(){let e={settings:this.settings,registry:this.registry};await this.saveData(e),this.settings.useIntegratedServer?(this.stopServer(),this.startServer()):this.stopServer()}};
//# sourceMappingURL=main.js.map
