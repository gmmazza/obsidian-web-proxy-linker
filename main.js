"use strict";var $=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var M=Object.prototype.hasOwnProperty;var q=(r,n)=>{for(var t in n)$(r,t,{get:n[t],enumerable:!0})},K=(r,n,t,e)=>{if(n&&typeof n=="object"||typeof n=="function")for(let i of H(n))!M.call(r,i)&&i!==t&&$(r,i,{get:()=>n[i],enumerable:!(e=E(n,i))||e.enumerable});return r};var B=r=>K($({},"__esModule",{value:!0}),r);var J={};q(J,{default:()=>L});module.exports=B(J);var g=require("obsidian");var u=require("obsidian"),I=class extends u.PluginSettingTab{constructor(n,t){super(n,t),this.plugin=t}display(){let{containerEl:n}=this;n.empty(),n.createEl("h2",{text:"Web Proxy Linker"}),n.createEl("h3",{text:"Server configuration"}),new u.Setting(n).setName("Use integrated server").setDesc("Starts http://127.0.0.1:<port>. If sandboxed, it will auto-disable.").addToggle(t=>t.setValue(this.plugin.settings.useIntegratedServer).onChange(async e=>{this.plugin.settings.useIntegratedServer=e,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.useIntegratedServer?(new u.Setting(n).setName("Server port").setDesc("Default 27124").addText(t=>t.setPlaceholder("27124").setValue(String(this.plugin.settings.serverPort)).onChange(async e=>{let i=parseInt(e,10);!isNaN(i)&&i>0&&i<65536&&(this.plugin.settings.serverPort=i),await this.plugin.saveSettings()})),new u.Setting(n).setName("Listen host").setDesc("Use 127.0.0.1 to keep it local only").addText(t=>t.setPlaceholder("127.0.0.1").setValue(this.plugin.settings.listenHost).onChange(async e=>{this.plugin.settings.listenHost=(e||"127.0.0.1").trim(),await this.plugin.saveSettings()}))):new u.Setting(n).setName("External proxy Base URL").setDesc("Only used if integrated server is OFF").addText(t=>t.setPlaceholder("http://localhost:27124").setValue(this.plugin.settings.baseUrl).onChange(async e=>{this.plugin.settings.baseUrl=e.trim(),await this.plugin.saveSettings()})),n.createEl("h3",{text:"Link generation"}),new u.Setting(n).setName("Route style").setDesc("'query' uses /open?u=..., 'pretty' uses /v/<Vault>/<path>?h=Heading").addDropdown(t=>t.addOptions({query:"query",pretty:"pretty"}).setValue(this.plugin.settings.routeStyle).onChange(async e=>{this.plugin.settings.routeStyle=e,await this.plugin.saveSettings()})),new u.Setting(n).setName("Add current heading if available").setDesc("Automatically add heading anchor based on the cursor position").addToggle(t=>t.setValue(this.plugin.settings.addHeadingAnchor).onChange(async e=>{this.plugin.settings.addHeadingAnchor=e,await this.plugin.saveSettings()})),new u.Setting(n).setName("Vault name override (optional)").setDesc("Leave empty to use the vault's real name").addText(t=>t.setPlaceholder("MyVault").setValue(this.plugin.settings.vaultNameOverride).onChange(async e=>{this.plugin.settings.vaultNameOverride=e.trim(),await this.plugin.saveSettings()})),n.createEl("h3",{text:"Linking strategy"}),new u.Setting(n).setName("Strategy").setDesc("Choose how links stay stable when files move").addDropdown(t=>t.addOptions({path:"Path (smart fallback)","frontmatter-uid":"Frontmatter UID","local-registry":"Local registry (no file changes)"}).setValue(this.plugin.settings.linkStrategy).onChange(async e=>{this.plugin.settings.linkStrategy=e,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.linkStrategy==="frontmatter-uid"&&(n.createEl("h3",{text:"Frontmatter UID"}),new u.Setting(n).setName("Use Note UID Generator compatibility").setDesc("Respect the same YAML key if that plugin is present").addToggle(t=>t.setValue(this.plugin.settings.useNoteUidCompat).onChange(async e=>{this.plugin.settings.useNoteUidCompat=e,await this.plugin.saveSettings()})),new u.Setting(n).setName("Preferred YAML key").setDesc("Key used to read/write UID in frontmatter").addText(t=>t.setPlaceholder("uid").setValue(this.plugin.settings.frontmatterUidKeyPreferred).onChange(async e=>{this.plugin.settings.frontmatterUidKeyPreferred=(e||"uid").trim(),await this.plugin.saveSettings()})),new u.Setting(n).setName("Also recognize keys").setDesc("Comma-separated list (e.g. uid,note_uid,noteId,id)").addText(t=>t.setPlaceholder("uid,note_uid,noteId,id").setValue(this.plugin.settings.frontmatterUidKeys.join(",")).onChange(async e=>{this.plugin.settings.frontmatterUidKeys=(e||"").split(",").map(i=>i.trim()).filter(Boolean),await this.plugin.saveSettings()})),new u.Setting(n).setName("Auto-assign UID if missing").setDesc("Assign a UID on first use if the note has none").addToggle(t=>t.setValue(this.plugin.settings.autoAssignUid).onChange(async e=>{this.plugin.settings.autoAssignUid=e,await this.plugin.saveSettings()})),new u.Setting(n).setName("UID format").setDesc("Default uuid-v4; nanoid-21 is compact; timestamp-rand is sortable").addDropdown(t=>t.addOptions({"uuid-v4":"uuid-v4","nanoid-21":"nanoid-21","timestamp-rand":"timestamp-rand"}).setValue(this.plugin.settings.uidFormat).onChange(async e=>{this.plugin.settings.uidFormat=e,await this.plugin.saveSettings()})))}};var P={routeStyle:"query",addHeadingAnchor:!0,vaultNameOverride:"",baseUrl:"http://127.0.0.1:27124",useIntegratedServer:!0,serverPort:27124,listenHost:"127.0.0.1",linkStrategy:"path",useNoteUidCompat:!0,noteUidPluginId:null,frontmatterUidKeys:["uid","note_uid","noteId","id"],frontmatterUidKeyPreferred:"uid",autoAssignUid:!1,uidFormat:"uuid-v4"};function W(r){return r.replace(/\/+$/,"")}function U(r,n){var t;return((t=n.vaultNameOverride)==null?void 0:t.trim())||r.vault.getName()}function N(r){return r.useIntegratedServer?`http://${r.listenHost||"127.0.0.1"}:${r.serverPort}`:W(r.baseUrl||"http://127.0.0.1:27124")}function k(r,n,t){var i;let e=(i=r.metadataCache.getFileCache(n))==null?void 0:i.frontmatter;if(e)for(let s of t){let o=e[s];if(typeof o=="string"&&o.trim())return o.trim()}}async function D(r,n,t){let e=k(r,n,[t.frontmatterUidKeyPreferred,...t.frontmatterUidKeys]);if(e)return e;if(t.autoAssignUid){e=j(t.uidFormat);try{return await r.fileManager.processFrontMatter(n,i=>{i[t.frontmatterUidKeyPreferred]=e}),e}catch(i){return}}}function j(r){if(r==="uuid-v4")return _();if(r==="nanoid-21")return G();let n=Math.random().toString(36).slice(2,10);return`${Date.now().toString(36)}-${n}`}function _(){var t;let r=globalThis;if((t=r.crypto)!=null&&t.getRandomValues){let e=new Uint8Array(16);r.crypto.getRandomValues(e),e[6]=e[6]&15|64,e[8]=e[8]&63|128;let i=[...e].map(s=>s.toString(16).padStart(2,"0")).join("");return`${i.slice(0,8)}-${i.slice(8,12)}-${i.slice(12,16)}-${i.slice(16,20)}-${i.slice(20)}`}let n="";for(let e=0;e<36;e++)n+="x";return n.replace(/[xy]/g,e=>{let i=Math.random()*16|0;return(e==="x"?i:i&3|8).toString(16)})}function G(){var i;let r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz-",n=globalThis,t=new Uint8Array(21);if((i=n.crypto)!=null&&i.getRandomValues)n.crypto.getRandomValues(t);else for(let s=0;s<t.length;s++)t[s]=Math.random()*256|0;let e="";for(let s=0;s<t.length;s++)e+=r[t[s]&63];return e}var C=class{constructor(n,t,e){this.uidIndex=new Map;this.app=n,this.settings=t,this.plugin=e}rebuildAll(){this.uidIndex.clear();let n=this.app.vault.getFiles();for(let t of n){let e=k(this.app,t,[this.settings.frontmatterUidKeyPreferred,...this.settings.frontmatterUidKeys]);e&&this.uidIndex.set(e,t.path)}}getPathByUid(n){if(n)return this.uidIndex.get(n)}onFrontmatterChanged(n){let t=k(this.app,n,[this.settings.frontmatterUidKeyPreferred,...this.settings.frontmatterUidKeys]);for(let[e,i]of Array.from(this.uidIndex.entries()))i===n.path&&this.uidIndex.delete(e);t&&this.uidIndex.set(t,n.path)}onFileRenamed(n,t){for(let[e,i]of Array.from(this.uidIndex.entries()))i===n&&this.uidIndex.set(e,t.path);for(let[e,i]of Object.entries(this.plugin.registry))i===n&&(this.plugin.registry[e]=t.path)}onFileDeleted(n){for(let[t,e]of Array.from(this.uidIndex.entries()))e===n&&this.uidIndex.delete(t);for(let[t,e]of Object.entries(this.plugin.registry))e===n&&delete this.plugin.registry[t]}getPathByLocalId(n){if(n)return this.plugin.registry[n]}ensureLocalIdForPath(n){for(let[e,i]of Object.entries(this.plugin.registry))if(i===n)return e;let t=this.makeLocalId();return this.plugin.registry[t]=n,t}makeLocalId(){let n=Math.random().toString(36).slice(2,10);return`${Date.now().toString(36)}-${n}`}};var A=require("obsidian");function b(r,n){let e=r.workspace.getLeavesOfType("search")[0]||r.workspace.getRightLeaf(!1);e.setViewState({type:"search",state:{query:n}}),r.workspace.revealLeaf(e)}function V(){let r=window;return typeof r.require=="function"?r.require:null}function Q(){let r=V();if(!r)return null;try{return r("http")}catch(n){return null}}function z(){let r=V();if(!r)return null;try{return r("electron").shell}catch(n){return null}}var F=class{constructor(n){this.server=null;this.plugin=n}start(){if(this.server)return;let n=Q(),t=z();if(!n||!t)return;let{settings:e,app:i}=this.plugin,s=e.serverPort,o=e.listenHost||"127.0.0.1";this.server=n.createServer((d,a)=>this.handleRequest(d,a,t)),this.server.on("error",d=>{console.error("Proxy server error",d)}),this.server.listen(s,o,()=>{})}stop(){if(this.server){try{this.server.close()}catch(n){}this.server=null}}htmlOk(n="Opening in Obsidian\u2026 you can close this tab."){return`<!doctype html><meta charset="utf-8"><meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'">${n}`}handleRequest(n,t,e){let{app:i,settings:s,indexer:o}=this.plugin;try{let d=n.headers.host||"127.0.0.1",a=new URL(n.url||"/",`http://${d}`);if(t.setHeader("X-Content-Type-Options","nosniff"),t.setHeader("Content-Type","text/html; charset=utf-8"),a.pathname==="/ping"||a.pathname==="/health"){t.statusCode=200,t.end(this.htmlOk("OK"));return}if(a.pathname==="/open"){let h=a.searchParams.get("u")||"",v=a.searchParams.get("uid"),x=a.searchParams.get("id"),S=a.searchParams.get("h")||void 0,m=Y(h),f=m?O(m):void 0,p;if(v&&(p=o.getPathByUid(v)),!p&&x&&(p=o.getPathByLocalId(x)),!p&&f){let l=i.vault.getFiles().filter(c=>c.basename===f);if(l.length>1){b(i,w(f)),t.statusCode=200,t.end(this.htmlOk("Multiple files match; opened Search."));return}l.length===1&&(p=l[0].path)}if(!p&&m){let l=i.vault.getAbstractFileByPath(m);if(l&&l instanceof A.TFile)p=m;else if(f){b(i,w(f)),t.statusCode=200,t.end(this.htmlOk("File moved; opened Search."));return}}if(p){let l=encodeURIComponent(i.vault.getName()),c=encodeURIComponent(p),y=`obsidian://open?vault=${l}&file=${c}`;S&&(y+=`#${encodeURIComponent(S)}`),e.openExternal(y),t.statusCode=200,t.end(this.htmlOk());return}if(h&&/^obsidian:\/\//i.test(decodeURIComponent(h))){e.openExternal(decodeURIComponent(h)),t.statusCode=200,t.end(this.htmlOk());return}t.statusCode=404,t.end("Not found");return}if(a.pathname.startsWith("/v/")){let h=a.searchParams.get("uid"),v=a.searchParams.get("id"),x=a.searchParams.get("h")||void 0,S=a.pathname.split("/").slice(2),m=S.shift()||"",f=S.map(c=>decodeURIComponent(c)).join("/"),p=O(f),l;if(h&&(l=o.getPathByUid(h)),!l&&v&&(l=o.getPathByLocalId(v)),!l&&p){let c=i.vault.getFiles().filter(y=>y.basename===p);if(c.length>1){b(i,w(p)),t.statusCode=200,t.end(this.htmlOk("Multiple files match; opened Search."));return}c.length===1&&(l=c[0].path)}if(!l&&f){let c=i.vault.getAbstractFileByPath(f);if(c&&c instanceof A.TFile)l=f;else if(p){b(i,w(p)),t.statusCode=200,t.end(this.htmlOk("File moved; opened Search."));return}}if(l){let c=encodeURIComponent(i.vault.getName()),y=encodeURIComponent(l),T=`obsidian://open?vault=${c}&file=${y}`;x&&(T+=`#${encodeURIComponent(x)}`),e.openExternal(T),t.statusCode=200,t.end(this.htmlOk());return}t.statusCode=404,t.end("Not found");return}t.statusCode=404,t.end("Not found")}catch(d){console.error(d),t.statusCode=500,t.end("Internal error")}}};function Y(r){if(!r)return;let n;try{n=decodeURIComponent(r)}catch(t){n=r}if(/^obsidian:\/\//i.test(n))try{let e=new URL(n).searchParams.get("file");if(!e)return;try{return decodeURIComponent(e)}catch(i){return e}}catch(t){return}}function O(r){let n=r.split("/").pop()||r,t=n.lastIndexOf(".");return t>0?n.slice(0,t):n}function w(r){return`file:"${r.replace(/"/g,'\\"')}"`}function X(r,n,t,e){let i=encodeURIComponent(U(r,n)),s=encodeURIComponent(t.path),o=`obsidian://open?vault=${i}&file=${s}`;return e&&(o+=`#${encodeURIComponent(e)}`),o}async function R(r,n,t,e,i){let s=N(n),o=X(r,n,e,i),d=i?`&h=${encodeURIComponent(i)}`:"";switch(n.linkStrategy){case"frontmatter-uid":{let a=await D(r,e,n);return n.routeStyle==="pretty"?`${s}/v/${encodeURIComponent(U(r,n))}/${e.path.split("/").map(encodeURIComponent).join("/")}?uid=${encodeURIComponent(a||"")}${d}`:`${s}/open?uid=${encodeURIComponent(a||"")}&u=${encodeURIComponent(o)}${d}`}case"local-registry":{let a=t.ensureLocalIdForPath(e.path);return n.routeStyle==="pretty"?`${s}/v/${encodeURIComponent(U(r,n))}/${e.path.split("/").map(encodeURIComponent).join("/")}?id=${encodeURIComponent(a)}${d}`:`${s}/open?id=${encodeURIComponent(a)}&u=${encodeURIComponent(o)}${d}`}case"path":default:if(n.routeStyle==="pretty"){let a=i?`?h=${encodeURIComponent(i)}`:"";return`${s}/v/${encodeURIComponent(U(r,n))}/${e.path.split("/").map(encodeURIComponent).join("/")}${a}`}else return`${s}/open?u=${encodeURIComponent(o)}`}}var L=class extends g.Plugin{constructor(){super(...arguments);this.settings=P;this.registry={};this.server=null}async onload(){await this.loadSettings(),this.indexer=new C(this.app,this.settings,this),this.indexer.rebuildAll(),this.registerEvent(this.app.metadataCache.on("changed",t=>{t instanceof g.TFile&&this.indexer.onFrontmatterChanged(t)})),this.registerEvent(this.app.vault.on("rename",(t,e)=>{t instanceof g.TFile&&this.indexer.onFileRenamed(e,t)})),this.registerEvent(this.app.vault.on("delete",t=>{t instanceof g.TFile&&this.indexer.onFileDeleted(t.path)})),this.addRibbonIcon("link","Copy web-proxy link of current note",async()=>{let t=this.app.workspace.getActiveFile();if(!t)return new g.Notice("No active note");await this.copyForFile(t,!0)}),this.addCommand({id:"copy-proxy-link-current",name:"Copy web-proxy link of current note",editorCheckCallback:(t,e,i)=>{let s=this.app.workspace.getActiveFile();return s?(t||this.copyForFile(s,!0),!0):!1}}),this.addCommand({id:"insert-proxy-link-current",name:"Insert web-proxy link into editor",editorCheckCallback:(t,e,i)=>{let s=this.app.workspace.getActiveFile();return s?(t||this.insertLinkInEditor(s,e),!0):!1}}),this.registerEvent(this.app.workspace.on("file-menu",(t,e)=>{e instanceof g.TFile&&t.addItem(i=>i.setTitle("Copy web-proxy link").setIcon("link").onClick(()=>this.copyForFile(e,!1)))})),this.addSettingTab(new I(this.app,this)),this.settings.useIntegratedServer&&this.startServer()}onunload(){this.stopServer()}startServer(){this.server||(this.server=new F(this),this.server.start(),this.settings.useIntegratedServer&&new g.Notice(`Web Proxy Linker: server ${this.settings.listenHost}:${this.settings.serverPort}`))}stopServer(){this.server&&(this.server.stop(),this.server=null)}getHeadingFromEditorIfAny(t){var o;if(!this.settings.addHeadingAnchor)return;let e=this.app.workspace.getActiveViewOfType(g.MarkdownView);if(!e||((o=e.file)==null?void 0:o.path)!==t.path)return;let i=e.editor,s=i.getCursor().line;for(let d=s;d>=0;d--){let a=i.getLine(d),h=/^\s*#+\s+(.+)$/.exec(a);if(h)return h[1].trim()}}async copyForFile(t,e){let i=e?this.getHeadingFromEditorIfAny(t):void 0,s=await R(this.app,this.settings,this.indexer,t,i),o=await this.copyToClipboard(s);new g.Notice(o?"Link copied to clipboard":s)}async insertLinkInEditor(t,e){let i=this.getHeadingFromEditorIfAny(t),s=await R(this.app,this.settings,this.indexer,t,i),d=`[${t.basename+(i?` \u2014 ${i}`:"")}](${s})`;e.replaceSelection(d),new g.Notice("Link inserted")}async copyToClipboard(t){try{return await navigator.clipboard.writeText(t),!0}catch(e){try{let i=document.createElement("textarea");return i.value=t,document.body.appendChild(i),i.select(),document.execCommand("copy"),i.remove(),!0}catch(i){return!1}}}async loadSettings(){let t=await this.loadData();if(!t){this.settings={...P},this.registry={};return}if(t&&t.routeStyle)this.settings=Object.assign({},P,t),this.registry={};else{let e=t;this.settings=Object.assign({},P,e.settings),this.registry=e.registry||{}}["path","frontmatter-uid","local-registry"].includes(this.settings.linkStrategy)||(this.settings.linkStrategy="path")}async saveSettings(){let t={settings:this.settings,registry:this.registry};await this.saveData(t),this.settings.useIntegratedServer?(this.stopServer(),this.startServer()):this.stopServer()}};
//# sourceMappingURL=main.js.map
