"use strict";var L=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var M=Object.prototype.hasOwnProperty;var K=(r,n)=>{for(var e in n)L(r,e,{get:n[e],enumerable:!0})},q=(r,n,e,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let i of H(n))!M.call(r,i)&&i!==e&&L(r,i,{get:()=>n[i],enumerable:!(t=E(n,i))||t.enumerable});return r};var B=r=>q(L({},"__esModule",{value:!0}),r);var J={};K(J,{default:()=>$});module.exports=B(J);var g=require("obsidian");var l=require("obsidian"),C=class extends l.PluginSettingTab{constructor(n,e){super(n,e),this.plugin=e}display(){let{containerEl:n}=this;n.empty(),n.createEl("h2",{text:"Web Proxy Linker"}),new l.Setting(n).setName("Use integrated server").setDesc("Starts http://127.0.0.1:<port>. If sandboxed, it will auto-disable.").addToggle(e=>e.setValue(this.plugin.settings.useIntegratedServer).onChange(async t=>{this.plugin.settings.useIntegratedServer=t,await this.plugin.saveSettings()})),new l.Setting(n).setName("Server port").setDesc("Default 27124").addText(e=>e.setPlaceholder("27124").setValue(String(this.plugin.settings.serverPort)).onChange(async t=>{let i=parseInt(t,10);!isNaN(i)&&i>0&&i<65536&&(this.plugin.settings.serverPort=i),await this.plugin.saveSettings()})),new l.Setting(n).setName("Listen host").setDesc("Use 127.0.0.1 to keep it local only").addText(e=>e.setPlaceholder("127.0.0.1").setValue(this.plugin.settings.listenHost).onChange(async t=>{this.plugin.settings.listenHost=(t||"127.0.0.1").trim(),await this.plugin.saveSettings()})),new l.Setting(n).setName("External proxy Base URL").setDesc("Only used if integrated server is OFF").addText(e=>e.setPlaceholder("http://localhost:27124").setValue(this.plugin.settings.baseUrl).onChange(async t=>{this.plugin.settings.baseUrl=t.trim(),await this.plugin.saveSettings()})),new l.Setting(n).setName("Route style").setDesc("'query' uses /open?u=..., 'pretty' uses /v/<Vault>/<path>?h=Heading").addDropdown(e=>e.addOptions({query:"query",pretty:"pretty"}).setValue(this.plugin.settings.routeStyle).onChange(async t=>{this.plugin.settings.routeStyle=t,await this.plugin.saveSettings()})),new l.Setting(n).setName("Add current heading if available").setDesc("Automatically add heading anchor based on the cursor position").addToggle(e=>e.setValue(this.plugin.settings.addHeadingAnchor).onChange(async t=>{this.plugin.settings.addHeadingAnchor=t,await this.plugin.saveSettings()})),new l.Setting(n).setName("Vault name override (optional)").setDesc("Leave empty to use the vault's real name").addText(e=>e.setPlaceholder("MyVault").setValue(this.plugin.settings.vaultNameOverride).onChange(async t=>{this.plugin.settings.vaultNameOverride=t.trim(),await this.plugin.saveSettings()})),n.createEl("h3",{text:"Linking strategy"}),new l.Setting(n).setName("Strategy").setDesc("Choose how links stay stable when files move").addDropdown(e=>e.addOptions({path:"Path (smart fallback)","frontmatter-uid":"Frontmatter UID","local-registry":"Local registry (no file changes)",basename:"Basename (search on duplicates)"}).setValue(this.plugin.settings.linkStrategy).onChange(async t=>{this.plugin.settings.linkStrategy=t,await this.plugin.saveSettings()})),n.createEl("h3",{text:"Frontmatter UID"}),new l.Setting(n).setName("Use Note UID Generator compatibility").setDesc("Respect the same YAML key if that plugin is present").addToggle(e=>e.setValue(this.plugin.settings.useNoteUidCompat).onChange(async t=>{this.plugin.settings.useNoteUidCompat=t,await this.plugin.saveSettings()})),new l.Setting(n).setName("Preferred YAML key").setDesc("Key used to read/write UID in frontmatter").addText(e=>e.setPlaceholder("uid").setValue(this.plugin.settings.frontmatterUidKeyPreferred).onChange(async t=>{this.plugin.settings.frontmatterUidKeyPreferred=(t||"uid").trim(),await this.plugin.saveSettings()})),new l.Setting(n).setName("Also recognize keys").setDesc("Comma-separated list (e.g. uid,note_uid,noteId,id)").addText(e=>e.setPlaceholder("uid,note_uid,noteId,id").setValue(this.plugin.settings.frontmatterUidKeys.join(",")).onChange(async t=>{this.plugin.settings.frontmatterUidKeys=(t||"").split(",").map(i=>i.trim()).filter(Boolean),await this.plugin.saveSettings()})),new l.Setting(n).setName("Auto-assign UID if missing").setDesc("Assign a UID on first use if the note has none").addToggle(e=>e.setValue(this.plugin.settings.autoAssignUid).onChange(async t=>{this.plugin.settings.autoAssignUid=t,await this.plugin.saveSettings()})),new l.Setting(n).setName("UID format").setDesc("Default uuid-v4; nanoid-21 is compact; timestamp-rand is sortable").addDropdown(e=>e.addOptions({"uuid-v4":"uuid-v4","nanoid-21":"nanoid-21","timestamp-rand":"timestamp-rand"}).setValue(this.plugin.settings.uidFormat).onChange(async t=>{this.plugin.settings.uidFormat=t,await this.plugin.saveSettings()}))}};var U={routeStyle:"query",addHeadingAnchor:!0,vaultNameOverride:"",baseUrl:"http://127.0.0.1:27124",useIntegratedServer:!0,serverPort:27124,listenHost:"127.0.0.1",linkStrategy:"path",useNoteUidCompat:!0,noteUidPluginId:null,frontmatterUidKeys:["uid","note_uid","noteId","id"],frontmatterUidKeyPreferred:"uid",autoAssignUid:!1,uidFormat:"uuid-v4"};function W(r){return r.replace(/\/+$/,"")}function v(r,n){var e;return((e=n.vaultNameOverride)==null?void 0:e.trim())||r.vault.getName()}function N(r){return r.useIntegratedServer?`http://${r.listenHost||"127.0.0.1"}:${r.serverPort}`:W(r.baseUrl||"http://127.0.0.1:27124")}function k(r,n,e){var i;let t=(i=r.metadataCache.getFileCache(n))==null?void 0:i.frontmatter;if(t)for(let s of e){let a=t[s];if(typeof a=="string"&&a.trim())return a.trim()}}async function D(r,n,e){let t=k(r,n,[e.frontmatterUidKeyPreferred,...e.frontmatterUidKeys]);if(t)return t;if(e.autoAssignUid){t=j(e.uidFormat);try{return await r.fileManager.processFrontMatter(n,i=>{i[e.frontmatterUidKeyPreferred]=t}),t}catch(i){return}}}function j(r){if(r==="uuid-v4")return _();if(r==="nanoid-21")return G();let n=Math.random().toString(36).slice(2,10);return`${Date.now().toString(36)}-${n}`}function _(){var e;let r=globalThis;if((e=r.crypto)!=null&&e.getRandomValues){let t=new Uint8Array(16);r.crypto.getRandomValues(t),t[6]=t[6]&15|64,t[8]=t[8]&63|128;let i=[...t].map(s=>s.toString(16).padStart(2,"0")).join("");return`${i.slice(0,8)}-${i.slice(8,12)}-${i.slice(12,16)}-${i.slice(16,20)}-${i.slice(20)}`}let n="";for(let t=0;t<36;t++)n+="x";return n.replace(/[xy]/g,t=>{let i=Math.random()*16|0;return(t==="x"?i:i&3|8).toString(16)})}function G(){var i;let r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz-",n=globalThis,e=new Uint8Array(21);if((i=n.crypto)!=null&&i.getRandomValues)n.crypto.getRandomValues(e);else for(let s=0;s<e.length;s++)e[s]=Math.random()*256|0;let t="";for(let s=0;s<e.length;s++)t+=r[e[s]&63];return t}var w=class{constructor(n,e,t){this.uidIndex=new Map;this.app=n,this.settings=e,this.plugin=t}rebuildAll(){this.uidIndex.clear();let n=this.app.vault.getFiles();for(let e of n){let t=k(this.app,e,[this.settings.frontmatterUidKeyPreferred,...this.settings.frontmatterUidKeys]);t&&this.uidIndex.set(t,e.path)}}getPathByUid(n){if(n)return this.uidIndex.get(n)}onFrontmatterChanged(n){let e=k(this.app,n,[this.settings.frontmatterUidKeyPreferred,...this.settings.frontmatterUidKeys]);for(let[t,i]of Array.from(this.uidIndex.entries()))i===n.path&&this.uidIndex.delete(t);e&&this.uidIndex.set(e,n.path)}onFileRenamed(n,e){for(let[t,i]of Array.from(this.uidIndex.entries()))i===n&&this.uidIndex.set(t,e.path);for(let[t,i]of Object.entries(this.plugin.registry))i===n&&(this.plugin.registry[t]=e.path)}onFileDeleted(n){for(let[e,t]of Array.from(this.uidIndex.entries()))t===n&&this.uidIndex.delete(e);for(let[e,t]of Object.entries(this.plugin.registry))t===n&&delete this.plugin.registry[e]}getPathByLocalId(n){if(n)return this.plugin.registry[n]}ensureLocalIdForPath(n){for(let[t,i]of Object.entries(this.plugin.registry))if(i===n)return t;let e=this.makeLocalId();return this.plugin.registry[e]=n,e}makeLocalId(){let n=Math.random().toString(36).slice(2,10);return`${Date.now().toString(36)}-${n}`}};var R=require("obsidian");function S(r,n){let t=r.workspace.getLeavesOfType("search")[0]||r.workspace.getRightLeaf(!1);t.setViewState({type:"search",state:{query:n}}),r.workspace.revealLeaf(t)}function V(){let r=window;return typeof r.require=="function"?r.require:null}function z(){let r=V();if(!r)return null;try{return r("http")}catch(n){return null}}function Q(){let r=V();if(!r)return null;try{return r("electron").shell}catch(n){return null}}var F=class{constructor(n){this.server=null;this.plugin=n}start(){if(this.server)return;let n=z(),e=Q();if(!n||!e)return;let{settings:t,app:i}=this.plugin,s=t.serverPort,a=t.listenHost||"127.0.0.1";this.server=n.createServer((d,o)=>this.handleRequest(d,o,e)),this.server.on("error",d=>{console.error("Proxy server error",d)}),this.server.listen(s,a,()=>{})}stop(){if(this.server){try{this.server.close()}catch(n){}this.server=null}}htmlOk(n="Opening in Obsidian\u2026 you can close this tab."){return`<!doctype html><meta charset="utf-8"><meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'">${n}`}handleRequest(n,e,t){let{app:i,settings:s,indexer:a}=this.plugin;try{let d=n.headers.host||"127.0.0.1",o=new URL(n.url||"/",`http://${d}`);if(e.setHeader("X-Content-Type-Options","nosniff"),e.setHeader("Content-Type","text/html; charset=utf-8"),o.pathname==="/ping"||o.pathname==="/health"){e.statusCode=200,e.end(this.htmlOk("OK"));return}if(o.pathname==="/open"){let h=o.searchParams.get("u")||"",x=o.searchParams.get("uid"),b=o.searchParams.get("id"),I=o.searchParams.get("bn")||void 0,P=o.searchParams.get("h")||void 0,f=Y(h),m=I||(f?O(f):void 0),p;if(x&&(p=a.getPathByUid(x)),!p&&b&&(p=a.getPathByLocalId(b)),!p&&m){let u=i.vault.getFiles().filter(c=>c.basename===m);if(u.length>1){S(i,m),e.statusCode=200,e.end(this.htmlOk("Multiple files match; opened Search."));return}u.length===1&&(p=u[0].path)}if(!p&&f){let u=i.vault.getAbstractFileByPath(f);if(u&&u instanceof R.TFile)p=f;else if(m){S(i,m),e.statusCode=200,e.end(this.htmlOk("File moved; opened Search."));return}}if(p){let u=encodeURIComponent(i.vault.getName()),c=encodeURIComponent(p),y=`obsidian://open?vault=${u}&file=${c}`;P&&(y+=`#${encodeURIComponent(P)}`),t.openExternal(y),e.statusCode=200,e.end(this.htmlOk());return}if(h&&/^obsidian:\/\//i.test(decodeURIComponent(h))){t.openExternal(decodeURIComponent(h)),e.statusCode=200,e.end(this.htmlOk());return}e.statusCode=404,e.end("Not found");return}if(o.pathname.startsWith("/v/")){let h=o.searchParams.get("uid"),x=o.searchParams.get("id"),b=o.searchParams.get("bn")||void 0,I=o.searchParams.get("h")||void 0,P=o.pathname.split("/").slice(2),f=P.shift()||"",m=P.map(c=>decodeURIComponent(c)).join("/"),p=b||O(m),u;if(h&&(u=a.getPathByUid(h)),!u&&x&&(u=a.getPathByLocalId(x)),!u&&p){let c=i.vault.getFiles().filter(y=>y.basename===p);if(c.length>1){S(i,p),e.statusCode=200,e.end(this.htmlOk("Multiple files match; opened Search."));return}c.length===1&&(u=c[0].path)}if(!u&&m){let c=i.vault.getAbstractFileByPath(m);if(c&&c instanceof R.TFile)u=m;else if(p){S(i,p),e.statusCode=200,e.end(this.htmlOk("File moved; opened Search."));return}}if(u){let c=encodeURIComponent(i.vault.getName()),y=encodeURIComponent(u),T=`obsidian://open?vault=${c}&file=${y}`;I&&(T+=`#${encodeURIComponent(I)}`),t.openExternal(T),e.statusCode=200,e.end(this.htmlOk());return}e.statusCode=404,e.end("Not found");return}e.statusCode=404,e.end("Not found")}catch(d){console.error(d),e.statusCode=500,e.end("Internal error")}}};function Y(r){if(!r)return;let n;try{n=decodeURIComponent(r)}catch(e){n=r}if(/^obsidian:\/\//i.test(n))try{let t=new URL(n).searchParams.get("file");if(!t)return;try{return decodeURIComponent(t)}catch(i){return t}}catch(e){return}}function O(r){let n=r.split("/").pop()||r,e=n.lastIndexOf(".");return e>0?n.slice(0,e):n}function X(r,n,e,t){let i=encodeURIComponent(v(r,n)),s=encodeURIComponent(e.path),a=`obsidian://open?vault=${i}&file=${s}`;return t&&(a+=`#${encodeURIComponent(t)}`),a}async function A(r,n,e,t,i){let s=N(n),a=X(r,n,t,i),d=i?`&h=${encodeURIComponent(i)}`:"";switch(n.linkStrategy){case"frontmatter-uid":{let o=await D(r,t,n);return n.routeStyle==="pretty"?`${s}/v/${encodeURIComponent(v(r,n))}/${t.path.split("/").map(encodeURIComponent).join("/")}?uid=${encodeURIComponent(o||"")}${d}`:`${s}/open?uid=${encodeURIComponent(o||"")}&u=${encodeURIComponent(a)}${d}`}case"local-registry":{let o=e.ensureLocalIdForPath(t.path);return n.routeStyle==="pretty"?`${s}/v/${encodeURIComponent(v(r,n))}/${t.path.split("/").map(encodeURIComponent).join("/")}?id=${encodeURIComponent(o)}${d}`:`${s}/open?id=${encodeURIComponent(o)}&u=${encodeURIComponent(a)}${d}`}case"basename":{let o=t.basename;return n.routeStyle==="pretty"?`${s}/v/${encodeURIComponent(v(r,n))}/${t.path.split("/").map(encodeURIComponent).join("/")}?bn=${encodeURIComponent(o)}${d}`:`${s}/open?bn=${encodeURIComponent(o)}&u=${encodeURIComponent(a)}${d}`}case"path":default:if(n.routeStyle==="pretty"){let o=i?`?h=${encodeURIComponent(i)}`:"";return`${s}/v/${encodeURIComponent(v(r,n))}/${t.path.split("/").map(encodeURIComponent).join("/")}${o}`}else return`${s}/open?u=${encodeURIComponent(a)}`}}var $=class extends g.Plugin{constructor(){super(...arguments);this.settings=U;this.registry={};this.server=null}async onload(){await this.loadSettings(),this.indexer=new w(this.app,this.settings,this),this.indexer.rebuildAll(),this.registerEvent(this.app.metadataCache.on("changed",e=>{e instanceof g.TFile&&this.indexer.onFrontmatterChanged(e)})),this.registerEvent(this.app.vault.on("rename",(e,t)=>{e instanceof g.TFile&&this.indexer.onFileRenamed(t,e)})),this.registerEvent(this.app.vault.on("delete",e=>{e instanceof g.TFile&&this.indexer.onFileDeleted(e.path)})),this.addRibbonIcon("link","Copy web-proxy link of current note",async()=>{let e=this.app.workspace.getActiveFile();if(!e)return new g.Notice("No active note");await this.copyForFile(e,!0)}),this.addCommand({id:"copy-proxy-link-current",name:"Copy web-proxy link of current note",editorCheckCallback:(e,t,i)=>{let s=this.app.workspace.getActiveFile();return s?(e||this.copyForFile(s,!0),!0):!1}}),this.addCommand({id:"insert-proxy-link-current",name:"Insert web-proxy link into editor",editorCheckCallback:(e,t,i)=>{let s=this.app.workspace.getActiveFile();return s?(e||this.insertLinkInEditor(s,t),!0):!1}}),this.registerEvent(this.app.workspace.on("file-menu",(e,t)=>{t instanceof g.TFile&&e.addItem(i=>i.setTitle("Copy web-proxy link").setIcon("link").onClick(()=>this.copyForFile(t,!1)))})),this.addSettingTab(new C(this.app,this)),this.settings.useIntegratedServer&&this.startServer()}onunload(){this.stopServer()}startServer(){this.server||(this.server=new F(this),this.server.start(),this.settings.useIntegratedServer&&new g.Notice(`Web Proxy Linker: server ${this.settings.listenHost}:${this.settings.serverPort}`))}stopServer(){this.server&&(this.server.stop(),this.server=null)}getHeadingFromEditorIfAny(e){var a;if(!this.settings.addHeadingAnchor)return;let t=this.app.workspace.getActiveViewOfType(g.MarkdownView);if(!t||((a=t.file)==null?void 0:a.path)!==e.path)return;let i=t.editor,s=i.getCursor().line;for(let d=s;d>=0;d--){let o=i.getLine(d),h=/^\s*#+\s+(.+)$/.exec(o);if(h)return h[1].trim()}}async copyForFile(e,t){let i=t?this.getHeadingFromEditorIfAny(e):void 0,s=await A(this.app,this.settings,this.indexer,e,i),a=await this.copyToClipboard(s);new g.Notice(a?"Link copied to clipboard":s)}async insertLinkInEditor(e,t){let i=this.getHeadingFromEditorIfAny(e),s=await A(this.app,this.settings,this.indexer,e,i),d=`[${e.basename+(i?` \u2014 ${i}`:"")}](${s})`;t.replaceSelection(d),new g.Notice("Link inserted")}async copyToClipboard(e){try{return await navigator.clipboard.writeText(e),!0}catch(t){try{let i=document.createElement("textarea");return i.value=e,document.body.appendChild(i),i.select(),document.execCommand("copy"),i.remove(),!0}catch(i){return!1}}}async loadSettings(){let e=await this.loadData();if(!e){this.settings={...U},this.registry={};return}if(e&&e.routeStyle)this.settings=Object.assign({},U,e),this.registry={};else{let t=e;this.settings=Object.assign({},U,t.settings),this.registry=t.registry||{}}}async saveSettings(){let e={settings:this.settings,registry:this.registry};await this.saveData(e),this.settings.useIntegratedServer?(this.stopServer(),this.startServer()):this.stopServer()}};
//# sourceMappingURL=main.js.map
